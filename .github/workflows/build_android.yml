name: Flutter Android Build

on:
# ... (Baaki code same rahega)

    steps:
      # ... (Initial steps: Checkout, Setup Java, Install Flutter, Cache pub)

      # CRITICAL FIX: GRADLE CACHE KO HATA DO
      # Taki build UP-TO-DATE hokar skip na ho.
      # - name: Cache Gradle
      # ... (Cache Gradle code comment out kiya hua)
            
      - name: Flutter Clean (Force fresh build)
        run: flutter clean

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build APK (Release) and Show Filtered Error
        shell: bash
        run: |
          echo "Starting Flutter Build... (Error details will be filtered)"
          
          BUILD_OUTPUT=$(flutter build apk --release --no-tree-shake-icons --dart-define=ACCESS_TOKEN=${{ secrets.MAPBOX_PUBLIC_TOKEN }} 2>&1) || true
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "------------------------------------------------------"
            echo "       ðŸš¨ BUILD FAILED - FILTERED ERROR DETAILS ðŸš¨"
            echo "------------------------------------------------------"
            echo "$BUILD_OUTPUT" | grep -E "FAILURE:|Caused by:|error:|Execution failed for task" -A 10 -B 5
            echo "------------------------------------------------------"
            exit $EXIT_CODE
          else
            echo "Build Success! APK Artifacts will be uploaded."
          fi
        env:
          MAPBOX_DOWNLOADS_TOKEN: ${{ secrets.MAPBOX_DOWNLOADS_TOKEN }}

      # ðŸ‘‡ FINAL FIX: Aapka diya hua Exact aur Confirmed Path Use Kiya Gaya Hai
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-final
          # Yahan exact path: build/app/outputs/flutter-apk/app-release.apk
          path: build/app/outputs/flutter-apk/app-release.apk
          
